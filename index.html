<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Empresas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Estilos para celdas editables */
        [contenteditable="true"] {
            background-color: #fef9c3; /* Amarillo claro */
            outline: 2px dashed #ca8a04; /* Borde dorado */
            outline-offset: -2px;
            transition: background-color 0.2s;
        }
        [contenteditable="true"]:focus {
            background-color: #ffffff;
            box-shadow: 0 0 0 2px #2563eb; /* Anillo de foco azul */
        }
        /* Ocultar scrollbar en el contenedor principal */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-full">
    <div class="flex h-full">
        <!-- Barra lateral (Sidebar) -->
        <div class="w-64 flex flex-col bg-gray-800 text-white shadow-lg">
            <div class="flex items-center justify-center h-20 shadow-md">
                <svg class="h-8 w-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m-1 4h1m6-4h1m-1 4h1m-1-8h1m-1 4h1m-1 4h1m-1 4h1m-1-8h1" />
                </svg>
                <h1 class="text-2xl font-bold ml-2">Directorio</h1>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" class="flex items-center px-4 py-2 text-gray-100 bg-gray-900 rounded-md">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4h.01M9 16h.01" />
                    </svg>
                    <span class="ml-3">Empresas</span>
                </a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <h3 class="text-sm font-semibold uppercase text-gray-400 mb-2">Estado</h3>
                <div id="status-container" class="space-y-2">
                    <div id="loading-spinner" class="flex items-center text-sm text-gray-300">
                        <svg class="animate-spin -ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Conectando...</span>
                    </div>
                    <p id="status-info" class="text-xs text-gray-400"></p>
                </div>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="h-20 flex items-center justify-between px-6 bg-white border-b border-gray-200">
                <!-- Barra de Búsqueda -->
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </span>
                    <input id="search-input" class="w-full max-w-xs pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" type="text" placeholder="Buscar por Razón Social...">
                </div>
                <!-- Botón de Descarga -->
                <button id="downloadBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-md shadow-md transition-colors duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Descargar CSV Actualizado
                </button>
            </header>
            
            <!-- Contenedor de la tabla con scroll -->
            <main class="flex-1 overflow-x-auto overflow-y-auto no-scrollbar p-6">
                <div id="table-wrapper" class="bg-white rounded-lg shadow-lg overflow-hidden hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr id="table-header">
                                <!-- Encabezados se generan dinámicamente -->
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Filas se generan dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        // URLs relativas a la ubicación de este index.html en tu repositorio de GitHub
        const baseDataURL = './base_datos_original.csv';
        const researchDataURL = './datos_investigados.csv';

        // Columnas que queremos que sean editables
        const editableColumns = ['EVALUACIÓN', 'Escriba OBSERVACIONES TEXTO'];
        
        // --- VARIABLES GLOBALES ---
        let allData = []; // La base de datos completa y fusionada
        let tableHeaders = [];
        
        // --- ELEMENTOS DEL DOM ---
        const statusInfo = document.getElementById('status-info');
        const downloadBtn = document.getElementById('downloadBtn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const tableWrapper = document.getElementById('table-wrapper');
        const tableHeader = document.getElementById('table-header');
        const tableBody = document.getElementById('data-table-body');
        const searchInput = document.getElementById('search-input');

        // --- INICIAR APLICACIÓN ---
        window.addEventListener('load', loadAndProcessData);
        downloadBtn.addEventListener('click', downloadCSV);
        searchInput.addEventListener('keyup', filterTable);

        /**
         * 1. Carga y parsea un archivo CSV desde una URL
         */
        function fetchAndParseCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,       // Carga el archivo desde la URL
                    header: true,         // La primera fila es de encabezados
                    skipEmptyLines: true, // Salta líneas vacías
                    encoding: "UTF-8",    // Asegura codificación correcta
                    delimiter: ",",       // DELIMITADOR CORREGIDO A COMA (,)
                    complete: resolve,
                    error: (err, file) => reject(new Error(`Error al parsear ${file}: ${err.message}`))
                });
            });
        }

        /**
         * 2. Orquesta la carga, fusión y renderizado de los datos
         */
        async function loadAndProcessData() {
            try {
                statusInfo.textContent = 'Cargando base principal...';
                const baseDataPromise = fetchAndParseCSV(baseDataURL);
                
                statusInfo.textContent = 'Cargando datos investigados...';
                const researchDataPromise = fetchAndParseCSV(researchDataURL);

                const [baseResults, researchResults] = await Promise.all([baseDataPromise, researchDataPromise]);

                if (!baseResults || !researchResults) {
                    throw new Error("No se pudieron cargar los archivos CSV.");
                }

                statusInfo.textContent = 'Fusionando bases de datos...';
                
                const baseData = baseResults.data;
                const researchData = researchResults.data;
                tableHeaders = baseResults.meta.fields; // Guardar los encabezados del archivo original

                // Crear un Mapa (Map) con los datos de investigación para un cruce rápido
                const researchMap = new Map();
                researchData.forEach(item => {
                    if (item["RAZÓN SOCIAL"]) {
                        researchMap.set(item["RAZÓN SOCIAL"].trim(), item);
                    }
                });

                const razonSocialKey = "RAZÓN SOCIAL";

                // Fusionar datos
                allData = baseData.map((item, index) => {
                    item._id = index; // Añadir un ID único para la edición
                    const razonSocial = item[razonSocialKey] ? item[razonSocialKey].trim() : null;

                    if (razonSocial && researchMap.has(razonSocial)) {
                        const research = researchMap.get(razonSocial);
                        item.WEB = research.WEB;
                        item["CORREO ELECTRONICO"] = research["CORREO ELECTRONICO"];
                    }
                    return item;
                });

                renderTable(allData); // Renderizar la tabla completa por primera vez

                // Actualizar UI
                loadingSpinner.style.display = 'none';
                tableWrapper.style.display = 'block';
                statusInfo.textContent = `Mostrando ${allData.length} empresas. ${researchMap.size} investigadas.`;
                downloadBtn.disabled = false;

            } catch (error) {
                loadingSpinner.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
                statusInfo.textContent = "Error de conexión. Revisa los nombres de archivo.";
            }
        }

        /**
         * 3. Dibuja la tabla en el DOM
         */
        function renderTable(dataToRender) {
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            const headerClasses = "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
            
            // Crear Encabezados
            tableHeaders.forEach(header => {
                const th = document.createElement('th');
                th.scope = "col";
                th.className = headerClasses;
                th.textContent = header;
                tableHeader.appendChild(th);
            });

            // Crear Filas
            dataToRender.forEach(item => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', item._id); // Asignar el ID único a la fila

                tableHeaders.forEach(header => {
                    const cell = createTableCell(item, header);
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });
        }

        /**
         * 4. Crea una celda (td) individual con la lógica de edición
         */
        function createTableCell(item, header) {
            const cell = document.createElement('td');
            const cellValue = item[header] || '';
            const cellClasses = "px-6 py-4 whitespace-nowrap text-sm text-gray-700";
            const linkClasses = "text-blue-600 hover:text-blue-800 hover:underline";
            const notFoundClasses = "text-gray-400";
            
            cell.className = cellClasses;
            cell.setAttribute('data-column', header); // Guardar el nombre de la columna

            // LÓGICA DE CELDAS EDITABLES
            if (editableColumns.includes(header)) {
                cell.setAttribute('contenteditable', 'true');
                cell.addEventListener('blur', saveCellEdit);
            }
            
            // Lógica de formato
            if (header === 'WEB' && cellValue && cellValue !== 'No encontrado') {
                cell.className = `${cellClasses} ${linkClasses}`;
                cell.innerHTML = `<a href="${cellValue.startsWith('http') ? cellValue : `http://${cellValue}`}" target="_blank" rel="noopener noreferrer">${cellValue}</a>`;
            } else if (header === 'CORREO ELECTRONICO' && cellValue && cellValue !== 'No encontrado') {
                cell.className = `${cellClasses} ${linkClasses}`;
                cell.innerHTML = `<a href="mailto:${cellValue}">${cellValue}</a>`;
            } else if (header === 'RAZÓN SOCIAL') {
                cell.className = `${cellClasses} font-medium text-gray-900`;
                cell.textContent = cellValue;
            } else {
                 cell.textContent = cellValue;
                 if (cellValue === 'No encontrado' || !cellValue) {
                    cell.className = `${cellClasses} ${notFoundClasses}`;
                    if(!cellValue) cell.textContent = '---';
                 }
            }
            return cell;
        }

        /**
         * 5. Guarda la edición de una celda en la variable global `allData`
         */
        function saveCellEdit(event) {
            const cell = event.target;
            const row = cell.closest('tr');
            const rowId = parseInt(row.getAttribute('data-id'), 10);
            const column = cell.getAttribute('data-column');
            const newValue = cell.textContent;

            // Encontrar el objeto en la base de datos global y actualizarlo
            const dataIndex = allData.findIndex(item => item._id === rowId);
            if (dataIndex > -1) {
                allData[dataIndex][column] = newValue;
                // Opcional: Mostrar una confirmación de guardado
                cell.style.backgroundColor = '#dcfce7'; // Verde claro
                setTimeout(() => { cell.style.backgroundColor = ''; }, 1000);
            }
        }

        /**
         * 6. Filtra la tabla basado en el input de búsqueda
         */
        function filterTable() {
            const query = searchInput.value.toLowerCase();
            if (query.length < 2) {
                renderTable(allData); // Mostrar todo si la búsqueda es corta
                return;
            }
            
            const filteredData = allData.filter(item => {
                const razonSocial = item["RAZÓN SOCIAL"] || '';
                return razonSocial.toLowerCase().includes(query);
            });
            
            renderTable(filteredData);
        }

        /**
         * 7. Descarga la base de datos `allData` (con modificaciones) como un CSV
         */
        function downloadCSV() {
            statusInfo.textContent = 'Generando CSV actualizado...';
            // Quitar el ID interno antes de descargar
            const dataToDownload = allData.map(item => {
                delete item._id;
                return item;
            });
            
            // Usar PapaParse para convertir JSON a CSV (Unparse)
            const csvContent = Papa.unparse(dataToDownload, {
                columns: tableHeaders, // Asegurar el orden original de las columnas
                delimiter: ",",
                header: true
            });

            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // BOM para UTF-8 Excel
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "base_de_datos_actualizada.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            statusInfo.textContent = 'CSV descargado con éxito.';
        }
    </script>
</body>
</html>

