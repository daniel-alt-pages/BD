<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Enriquecimiento de Datos</title>
    <!-- 1. Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
     /* Estilo simple para el loader principal */
     #root:empty + #loader {
       display: flex;
     }
     #loader {
       display: none;
     }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- 2. El contenedor donde se dibujará la aplicación React -->
    <div id="root"></div>

    <!-- Loader que se muestra si #root está vacío -->
    <div id="loader" class="flex justify-center items-center h-screen">
        <div class="text-xl font-semibold text-gray-700">Cargando plataforma...</div>
    </div>


    <!-- 3. Cargar React, ReactDOM y Babel -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <!-- Actualizado a Babel 7 para soportar sintaxis moderna (ej. ?.) -->
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>

    <!-- 4. Cargar Firebase (versión 9, compatible con la sintaxis global) -->
    <!-- Usamos una versión específica para compatibilidad en este entorno de preview -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <!-- 
      5. Nuestro código React. 
      Nota: type="text/babel" le dice a Babel que transpile este bloque.
    -->
    <script type_disabled="text/babel" data-type="module">
        // Hack para que Babel y los módulos funcionen juntos en este entorno
    </script>
    <script type="text/babel">
        'use strict';

        // --- Mapeo de dependencias a las variables globales ---
        const { useState, useEffect, useMemo, Fragment } = React;
        
        // Mapeamos desde la API global 'compat' de Firebase
        const { initializeApp } = firebase.app;
        
        // FIX: Ya no desestructuramos las funciones de auth y firestore.
        // Las llamaremos directamente desde las instancias de servicio 'db' y 'auth'
        // que creamos en setupFirebase.

        // --- INICIO: Código de EmailDashboard.jsx ---
        // (Aquí pegamos todo el código de nuestra app)

        let db;
        let auth;
        let appId;
        let collectionPath;

        /**
         * Inicializa Firebase y maneja la autenticación.
         */
        const setupFirebase = async (setUserId, setAuthReady) => {
          try {
            // Estas variables ( __firebase_config, __app_id, __initial_auth_token)
            // son proveídas por el entorno de preview.
            const firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            // Usamos firebase.initializeApp() de la versión 'compat'
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore(app);
            auth = firebase.auth(app);
            // firebase.firestore.setLogLevel('Debug'); // Habilitar para debug detallado

            // Llamamos a onAuthStateChanged como un método de la instancia 'auth'
            auth.onAuthStateChanged(async (user) => {
              if (user) {
                console.log("Usuario autenticado:", user.uid);
                collectionPath = `artifacts/${appId}/users/${user.uid}/contacts`;
                setUserId(user.uid);
                setAuthReady(true);
              } else if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                console.log("Autenticando con token personalizado...");
                // FIX: Llamar al método en la instancia 'auth'
                await auth.signInWithCustomToken(__initial_auth_token);
              } else {
                console.log("Autenticando anónimamente...");
                // FIX: Llamar al método en la instancia 'auth'
                await auth.signInAnonymously();
              }
            });

          } catch (error) {
            console.error("Error al inicializar Firebase:", error);
          }
        };

        /**
         * Icono SVG de Carga
         */
        function LoadingSpinner() {
          return (
            <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          );
        }

        /**
         * Procesador de Texto Copiado
         */
        function TextCaptureForm() {
          const [textData, setTextData] = useState('');
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState('');
          const [status, setStatus] = useState('');

          // Cargar la librería Papa Parse para leer CSV/TSV
          useEffect(() => {
            if (window.Papa) {
                console.log("Papa Parse ya estaba cargado.");
                return;
            }
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js';
            script.async = true;
            script.onload = () => console.log("Papa Parse cargado dinámicamente.");
            document.body.appendChild(script);
            return () => {
              // No removemos el script para que siga disponible
            }
          }, []);

          // --- Configuración de la API de IA (Gemini) ---
          const apiKey = "" // Proveída por el entorno
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

          const systemPrompt = `
            Eres un asistente de extracción de datos de alta precisión.
            Tu tarea es encontrar el SITIO WEB OFICIAL y el CORREO ELECTRÓNICO DE CONTACTO
            para la empresa específica que te proporciona el usuario.
            Debes usar la herramienta de Google Search.
            Prioriza correos de contacto genéricos (ej. info@, contacto@, ventas@, contactenos@).
            No inventes información. Si no encuentras un email o web, devuelve un string vacío "".
            Responde ÚNICAMENTE con el formato JSON solicitado.
          `;

          const jsonSchema = {
            type: "OBJECT",
            properties: {
              "nombre": { "type": "STRING" },
              "email": { "type": "STRING" },
              "web": { "type": "STRING" }
            },
            required: ["nombre", "email", "web"]
          };

          /**
           * Llama a la API de Gemini para UNA SOLA empresa
           */
          const getContactForCompany = async (companyName) => {
            const userQuery = `Encuentra el sitio web oficial y el correo de contacto para la empresa: "${companyName}"`;

            const payload = {
              contents: [{ parts: [{ text: userQuery }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] },
              tools: [{ "google_search": {} }],
              generationConfig: {
                responseMimeType: "application/json",
                responseSchema: jsonSchema
              }
            };

            let response;
            // Implementar reintento simple con backoff exponencial
            for (let i = 0; i < 3; i++) { 
              response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              if (response.ok) break; // Éxito
              if (response.status === 429 || response.status >= 500) {
                // Error de servidor o límite de tasa, esperar y reintentar
                await new Promise(res => setTimeout(res, 1000 * (2 ** i)));
              } else {
                // Otro error (ej. 400), no reintentar
                break;
              }
            }
            
            if (!response.ok) {
              throw new Error(`Error en la API de IA (${response.status}): ${response.statusText}`);
            }
            const result = await response.json();
            
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
              const jsonText = result.candidates[0].content.parts[0].text;
              const data = JSON.parse(jsonText);
              data.nombre = companyName; // Asegurarse que el nombre original se mantenga
              return data;
            } else {
              console.warn("Respuesta de la IA no tuvo contenido:", result);
              return { nombre: companyName, email: "", web: "" };
            }
          };
          
          /**
           * Guarda el contacto enriquecido en Firestore
           */
          const saveContactToFirestore = async (contact) => {
            try {
              // Usamos la API 'compat'
              await db.collection(collectionPath).add({
                nombre: contact.nombre,
                email: contact.email || '',
                web: contact.web || '',
                fuente: 'Captura Web IA',
                supervisor: contact.supervisor || '',
                capturadoEn: firebase.firestore.Timestamp.now() // API 'compat'
              });
            } catch (err) {
              console.error("Error guardando contacto individual:", err);
            }
          };

          /**
           * Manejador del envío del formulario
           */
          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!textData) {
              setError('Por favor, pega tus datos en el área de texto.');
              return;
            }
            if (typeof window.Papa === 'undefined') {
              setError('La librería de parseo aún no está lista. Intenta de nuevo en 2 segundos.');
              return;
            }
            
            setLoading(true);
            setError('');
            setStatus('Iniciando procesamiento del texto...');

            window.Papa.parse(textData, {
              header: true,
              // FIX: Cambiado de Tab a Coma para aceptar el formato CSV
              delimiter: ",", // Separador por Coma (CSV)
              skipEmptyLines: true,
              complete: async (results) => {
                const companies = results.data;
                if (!companies || companies.length === 0) {
                    setError('No se encontraron datos válidos. Revisa el formato (CSV - coma) y las cabeceras.');
                    setLoading(false);
                    return;
                }
                
                setStatus(`Texto leído. Se encontraron ${companies.length} empresas. Empezando captura...`);
                let processedCount = 0;
                
                for (const company of companies) {
                  const companyName = company["RAZÓN SOCIAL"];
                  const supervisor = company["SUPERVISOR"];
                  
                  if (!companyName) {
                    console.warn("Fila omitida, no se encontró 'RAZÓN SOCIAL':", company);
                    continue;
                  }

                  processedCount++;
                  setStatus(`[${processedCount}/${companies.length}] Buscando: "${companyName}"...`);
                  
                  try {
                    const contactData = await getContactForCompany(companyName);
                    contactData.supervisor = supervisor;
                    
                    if (contactData.email || contactData.web) {
                      setStatus(`[${processedCount}/${companies.length}] Encontrado: "${companyName}". Guardando...`);
                    } else {
                      setStatus(`[${processedCount}/${companies.length}] No se encontró info para: "${companyName}". Guardando solo nombre.`);
                    }
                    await saveContactToFirestore(contactData);
                    
                    // Pequeña pausa para no saturar la API
                    await new Promise(res => setTimeout(res, 500)); 

                  } catch (err) {
                    console.error(`Error procesando ${companyName}:`, err);
                    setError(`Error en ${companyName}: ${err.message}`);
                    // Continuar con el siguiente
                  }
                }
                
                setStatus(`Proceso completado. Se procesaron ${companies.length} empresas.`);
                setLoading(false);
                setTextData(''); // Limpiar el formulario
              },
              error: (err) => {
                setError(`Error al leer el texto: ${err.message}. Asegúrate que esté separado por coma (CSV).`);
                setLoading(false);
              }
            });
          };

          return (
            <div className="bg-white p-6 rounded-lg shadow-md mb-8">
              <h2 className="text-2xl font-semibold mb-4 text-gray-800">Enriquecedor por Lote de Texto</h2>
              <p className="text-gray-600 mb-4">
                {/* FIX: Instrucciones actualizadas a CSV */}
                Pega tu lista de empresas (con cabeceras `RAZÓN SOCIAL` y `SUPERVISOR`, separadas por coma (CSV)).
                El sistema buscará el `WEB` y `CORREO ELECTRONICO` para cada una.
              </p>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label htmlFor="textData" className="block text-sm font-medium text-gray-700">Pega tus datos (formato CSV) aquí</label>
                  <textarea
                    id="textData"
                    rows="10"
                    value={textData}
                    onChange={(e) => setTextData(e.target.value)}
                    placeholder={/* FIX: Placeholder actualizado a CSV */
`WEB,CORREO ELECTRONICO,EVALUACIÓN,Escriba OBSERVACIONES TEXTO,RAZÓN SOCIAL,SUPERVISOR
,,,,ESTYMA ESTUDIOS Y MANEJOS SA,SUPERSOCIEDADES
,,,,Empaquetaduras y Empaques S.A.,SUPERSOCIEDADES
...`
                    }
                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm font-mono"
                  />
                </div>
                <button
                  type="submit"
                  disabled={loading || !textData}
                  className="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed"
                >
                  {loading && <LoadingSpinner />}
                  {loading ? 'Procesando Lote...' : 'Iniciar Enriquecimiento'}
                </button>
                {status && <p className="text-blue-600 text-sm mt-2 font-medium">{status}</p>}
                {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
              </form>
            </div>
          );
        }

        /**
         * Componente principal de la aplicación
         */
        function App() {
          const [userId, setUserId] = useState(null);
          const [isAuthReady, setAuthReady] = useState(false);
          const [contacts, setContacts] = useState([]);
          const [loadingDB, setLoadingDB] = useState(true);
          const [searchTerm, setSearchTerm] = useState('');

          useEffect(() => {
            setupFirebase(setUserId, setAuthReady);
          }, []);

          useEffect(() => {
            if (!isAuthReady || !db || !userId) return;

            setLoadingDB(true);
            
            // Usamos la API 'compat'
            const q = db.collection(collectionPath);
            
            const unsubscribe = q.onSnapshot((querySnapshot) => {
              const contactsData = [];
              querySnapshot.forEach((doc) => {
                const data = doc.data();
                contactsData.push({
                  id: doc.id,
                  ...data,
                  // Convertir Timestamp de Firebase a Date de JS
                  capturadoEn: data.capturadoEn ? data.capturadoEn.toDate() : new Date() 
                });
              });
              // Ordenar por fecha, más reciente primero
              contactsData.sort((a, b) => b.capturadoEn - a.capturadoEn);
              setContacts(contactsData);
              setLoadingDB(false);
            }, (error) => {
              console.error("Error al escuchar la colección: ", error);
              setLoadingDB(false);
            });

            // Limpiar el listener al desmontar el componente
            return () => unsubscribe();
          }, [isAuthReady, userId]);

          // Memoizar los contactos filtrados para mejor rendimiento
          const filteredContacts = useMemo(() => {
            const term = searchTerm.toLowerCase();
            if (!term) return contacts;
            
            return contacts.filter(contact =>
              (contact.email && contact.email.toLowerCase().includes(term)) ||
              (contact.nombre && contact.nombre.toLowerCase().includes(term)) ||
              (contact.web && contact.web.toLowerCase().includes(term)) ||
              (contact.supervisor && contact.supervisor.toLowerCase().includes(term))
            );
          }, [contacts, searchTerm]);

          // Función para exportar los datos filtrados a CSV
          const exportToCSV = () => {
            let csvContent = "data:text/csv;charset=utf-8,Nombre (Razón Social),Supervisor,Email (Encontrado),Sitio Web (Encontrado),Fuente,Fecha de Captura\n";

            filteredContacts.forEach(item => {
              const row = [
                `"${item.nombre || ''}"`,
                `"${item.supervisor || ''}"`,
                `"${item.email || ''}"`,
                `"${item.web || ''}"`,
                `"${item.fuente || ''}"`,
                `"${item.capturadoEn.toLocaleString('es-ES')}"`
              ].join(",");
              csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `base_datos_enriquecida_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          // Mostrar loader mientras se autentica
          if (!isAuthReady) {
            return (
              <div className="flex justify-center items-center h-screen bg-gray-100">
                <div className="text-xl font-semibold text-gray-700">Conectando a la plataforma...</div>
              </div>
            );
          }
          
          const formatWebUrl = (url) => {
            if (!url) return null;
            if (url.startsWith('http://') || url.startsWith('https://')) {
              return url;
            }
            return `https://${url.replace(/^www\./i, '')}`;
          }

          // Renderizar la aplicación principal
          return (
            <div className="min-h-screen bg-gray-100 p-4 sm:p-8">
              <div className="max-w-7xl mx-auto">
                <header className="mb-6">
                  <h1 className="text-3xl font-bold text-gray-900">Plataforma de Enriquecimiento de Datos</h1>
                  <p className="text-xs text-gray-500 mt-1">ID de sesión: {userId}</p>
                </header>
                
                <TextCaptureForm />

                <div className="bg-white p-6 rounded-lg shadow-md">
                  <h2 className="text-2xl font-semibold mb-4 text-gray-800">Base de Datos en Tiempo Real</h2>
                  
                  <div className="flex flex-col sm:flex-row justify-between gap-4 mb-4">
                    <input
                      type="text"
                      placeholder="Buscar por nombre, supervisor, correo o web..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full sm:w-96 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    />
                    
                    <button
                      onClick={exportToCSV}
                      disabled={filteredContacts.length === 0}
                      className="w-full sm:w-auto flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                      Descargar (.csv)
                    </button>
                  </div>

                  <div className="overflow-x-auto rounded-lg border border-gray-200">
                    <table className="min-w-full divide-y divide-gray-200">
                      <thead className="bg-gray-50">
                        <tr>
                          <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre (Razón Social)</th>
                          <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supervisor</th>
                          <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email (Encontrado)</th>
                          <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sitio Web (Encontrado)</th>
                          <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Captura</th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {loadingDB && (
                          <tr>
                            <td colSpan="5" className="px-6 py-4 text-center text-gray-500">Cargando base de datos...</td>
                          </tr>
                        )}
                        {!loadingDB && contacts.length === 0 && (
                          <tr>
                            <td colSpan="5" className="px-6 py-4 text-center text-gray-500">
                              {searchTerm ? 'No hay resultados para tu búsqueda.' : 'Pega tus datos en el formulario de arriba para comenzar.'}
                            </td>
                          </tr>
                        )}
                        {!loadingDB && filteredContacts.map((contact) => {
                          const webUrl = formatWebUrl(contact.web);
                          return (
                            <tr key={contact.id} className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{contact.nombre || '-'}</td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{contact.supervisor || '-'}</td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                                {contact.email ? <a href={`mailto:${contact.email}`} className="hover:underline">{contact.email}</a> : <span className="text-gray-400">-</span>}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                                {webUrl ? <a href={webUrl} target="_blank" rel="noopener noreferrer" className="hover:underline">{contact.web}</a> : <span className="text-gray-400">-</span>}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{contact.capturadoEn.toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                  {filteredContacts.length > 0 && (
                    <p className="text-sm text-gray-600 mt-4">
                      Mostrando {filteredContacts.length} de {contacts.length} registros totales.
                    </p>
                  )}
                </div>
              </div>
            </div>
          );
        }

        // --- FIN: Código de EmailDashboard.jsx ---

        // 6. Renderizar la aplicación React en el DOM
        ReactDOM.render(
          React.createElement(App),
          document.getElementById('root')
        );

    </script>
</body>
</html>

