<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Base de Datos Conectado</title>
    <!-- Importamos Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importamos Papa Parse para leer archivos CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.0/papaparse.min.js"></script>
    <style>
        tbody tr:hover { background-color: #f9fafb; }
        th, td { min-width: 150px; }
        #loading-message {
            display: none;
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: #4B5563; /* text-gray-600 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">

    <div class="container mx-auto max-w-7xl">
        
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">
                Visor de Base de Datos Conectado
            </h1>
            <!-- Botón de Descarga -->
            <button id="downloadBtn" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-colors duration-200 ease-in-out" disabled>
                Descargar CSV Actualizado
            </button>
        </header>

        <p id="file-info" class="mb-4 text-sm text-gray-500">
            Cargando datos desde los archivos locales...
        </p>

        <!-- Mensaje de Carga -->
        <div id="loading-message" style="display: block;">
            <p>Cargando y combinando datos...</p>
        </div>

        <!-- Contenedor de la tabla -->
        <div id="table-container" class="bg-white rounded-lg shadow-lg overflow-x-auto" style="display: none;">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50" id="table-header">
                    <!-- El encabezado se generará dinámicamente -->
                </thead>
                <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Las filas de datos se insertarán aquí -->
                </tbody>
            </table>
        </div>

    </div>

    <script>
        // Almacenará todos los datos combinados
        let fullDatabaseData = [];
        let tableHeaders = [];

        // Nombres de los archivos
        const baseDataFile = './base_datos_original.csv';
        const researchDataFile = './datos_investigados.csv';

        document.addEventListener('DOMContentLoaded', () => {
            loadAndMergeData();
            document.getElementById('downloadBtn').addEventListener('click', downloadCSV);
        });

        /**
         * Carga y parsea un archivo CSV desde una URL.
         * Retorna una promesa con los datos parseados.
         */
        function fetchAndParseCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    encoding: "UTF-8",
                    delimiter: ";", // Usar punto y coma
                    complete: results => {
                        resolve(results.data);
                    },
                    error: err => {
                        console.error(`Error al cargar ${url}:`, err);
                        reject(err);
                    }
                });
            });
        }

        /**
         * Carga ambos CSVs, los combina y puebla la tabla.
         */
        async function loadAndMergeData() {
            const loadingMsg = document.getElementById('loading-message');
            const tableContainer = document.getElementById('table-container');
            const fileInfo = document.getElementById('file-info');

            try {
                // Cargar ambos archivos en paralelo
                const [baseData, researchDataList] = await Promise.all([
                    fetchAndParseCSV(baseDataFile),
                    fetchAndParseCSV(researchDataFile)
                ]);

                if (!baseData || baseData.length === 0) {
                    throw new Error("La base de datos original está vacía o no se pudo cargar.");
                }

                // Convertir los datos de investigación en un Mapa para búsqueda rápida
                const researchMap = new Map();
                researchDataList.forEach(item => {
                    if (item["RAZÓN SOCIAL"]) {
                        researchMap.set(item["RAZÓN SOCIAL"].trim(), {
                            web: item.WEB_INVESTIGADA,
                            email: item.EMAIL_INVESTIGADO
                        });
                    }
                });

                // --- Combinar los datos ---
                tableHeaders = Object.keys(baseData[0]); 
                fullDatabaseData = []; // Limpiar

                baseData.forEach(item => {
                    const razonSocialKey = "RAZÓN SOCIAL";
                    const razonSocial = item[razonSocialKey] ? item[razonSocialKey].trim() : null;

                    // Buscar en el mapa de investigación
                    if (razonSocial && researchMap.has(razonSocial)) {
                        const research = researchMap.get(razonSocial);
                        // Rellenar los campos WEB y CORREO ELECTRONICO
                        item.WEB = research.web;
                        item["CORREO ELECTRONICO"] = research.email;
                    }
                    
                    fullDatabaseData.push(item);
                });

                // Poblar la tabla
                populateTable();

                // Actualizar UI
                loadingMsg.style.display = 'none';
                tableContainer.style.display = 'block';
                fileInfo.textContent = `Mostrando ${fullDatabaseData.length} filas combinadas.`;
                document.getElementById('downloadBtn').disabled = false;

            } catch (error) {
                console.error("Error fatal al cargar y combinar datos:", error);
                loadingMsg.innerHTML = `<p class="text-red-600">Error al cargar los archivos de datos. Asegúrate de que los archivos 'base_datos_original.csv' y 'datos_investigados.csv' existan.</p>`;
            }
        }

        /**
         * Llena la tabla HTML con los datos combinados.
         */
        function populateTable() {
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('data-table-body');
            
            tableBody.innerHTML = '';
            tableHeader.innerHTML = '';

            // 1. Crear Encabezado
            const headerRow = document.createElement('tr');
            const headerClasses = "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
            tableHeaders.forEach(header => {
                const th = document.createElement('th');
                th.scope = "col";
                th.className = headerClasses;
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHeader.appendChild(headerRow);

            // 2. Crear Filas de Datos
            fullDatabaseData.forEach(item => {
                const row = document.createElement('tr');
                tableHeaders.forEach(header => {
                    const cell = createTableCell(item, header);
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });
        }

        /**
         * Crea una celda <td> para la tabla con formato especial.
         */
        function createTableCell(item, header) {
            const cell = document.createElement('td');
            const cellValue = item[header] || '';
            const cellClasses = "px-6 py-4 whitespace-nowrap text-sm text-gray-700";
            const linkClasses = "text-blue-600 hover:text-blue-800 hover:underline";
            const notFoundClasses = "text-gray-400";

            cell.className = cellClasses;

            if (header === 'WEB' && cellValue && cellValue !== 'No encontrado') {
                cell.className = `${cellClasses} ${linkClasses}`;
                const link = document.createElement('a');
                const url = cellValue.startsWith('http') ? cellValue : `http://${cellValue}`;
                link.href = url;
                link.textContent = cellValue;
                link.target = "_blank";
                link.rel = "noopener noreferrer";
                cell.appendChild(link);
            } else if (header === 'CORREO ELECTRONICO' && cellValue && cellValue !== 'No encontrado') {
                cell.className = `${cellClasses} ${linkClasses}`;
                const mailLink = document.createElement('a');
                mailLink.href = `mailto:${cellValue}`;
                mailLink.textContent = cellValue;
                cell.appendChild(mailLink);
            } else if (header === 'RAZÓN SOCIAL') {
                cell.className = `${cellClasses} font-medium text-gray-900`;
                cell.textContent = cellValue;
            } else {
                 cell.textContent = cellValue;
                 if (cellValue === 'No encontrado' || !cellValue) {
                    cell.className = `${cellClasses} ${notFoundClasses}`;
                    if(!cellValue) cell.textContent = '---';
                 }
            }
            return cell;
        }

        /**
         * Función para escapar datos para CSV (ahora maneja ;)
         */
        function escapeCSV(field) {
            if (field === null || field === undefined) {
                return '';
            }
            let str = String(field);
            // Escapar si contiene ";", " o newline
            if (str.includes(';') || str.includes('"') || str.includes('\n')) {
                str = `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        }

        /**
         * Genera y descarga un archivo CSV con los datos actuales.
         */
        function downloadCSV() {
            if (fullDatabaseData.length === 0) {
                console.warn("No hay datos para descargar.");
                return;
            }

            // Unir cabeceras con ;
            let csvContent = tableHeaders.join(";") + "\n";
            
            fullDatabaseData.forEach(item => {
                const row = tableHeaders.map(header => escapeCSV(item[header]));
                // Unir filas con ;
                csvContent += row.join(";") + "\n";
            });

            // Añadir BOM para compatibilidad con Excel
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "base_de_datos_combinada.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>

</body>
</html>

