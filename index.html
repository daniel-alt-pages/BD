<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Base de Datos Conectado</title>
    <!-- Importamos Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importamos Papa Parse para leer archivos CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        tbody tr:hover { background-color: #f9fafb; }
        th, td { min-width: 150px; }
        #loading-spinner { display: block; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container mx-auto max-w-7xl">
        
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">
                Visor de Base de Datos Conectado
            </h1>
            <!-- Botón de Descarga -->
            <button id="downloadBtn" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-colors duration-200 ease-in-out" disabled>
                Descargar CSV Actualizado
            </button>
        </header>

        <p id="status-info" class="mt-4 mb-4 text-sm text-gray-500"></p>

        <!-- Spinner de Carga -->
        <div id="loading-spinner" class="text-center p-8">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-gray-600">Conectando con las bases de datos...</p>
        </div>

        <!-- Contenedor de la tabla -->
        <div id="table-container" class="bg-white rounded-lg shadow-lg overflow-x-auto hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50" id="table-header">
                    <!-- El encabezado se generará dinámicamente -->
                </thead>
                <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Las filas de datos se insertarán aquí -->
                </tbody>
            </table>
        </div>

    </div>

    <script>
        // Nombres de los archivos en el repositorio
        const baseDataURL = './base_datos_original.csv';
        const researchDataURL = './datos_investigados.csv';

        let fullDatabaseData = [];
        let tableHeaders = [];

        const statusInfo = document.getElementById('status-info');
        const downloadBtn = document.getElementById('downloadBtn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const tableContainer = document.getElementById('table-container');

        // Iniciar la carga de datos al cargar la página
        window.addEventListener('load', loadAndProcessData);
        downloadBtn.addEventListener('click', downloadCSV);

        async function loadAndProcessData() {
            try {
                statusInfo.textContent = 'Cargando base de datos principal...';
                const baseDataPromise = fetchAndParseCSV(baseDataURL);
                
                statusInfo.textContent = 'Cargando datos de investigación...';
                const researchDataPromise = fetchAndParseCSV(researchDataURL);

                // Esperar a que ambos archivos se carguen
                const [baseResults, researchResults] = await Promise.all([baseDataPromise, researchDataPromise]);

                if (!baseResults || !researchResults) {
                    throw new Error("No se pudieron cargar los archivos CSV.");
                }

                statusInfo.textContent = 'Combinando bases de datos...';
                
                const baseData = baseResults.data;
                const researchData = researchResults.data;
                tableHeaders = baseResults.meta.fields;

                // Crear un Mapa (Map) con los datos de investigación para un cruce rápido
                const researchMap = new Map();
                researchData.forEach(item => {
                    if (item["RAZÓN SOCIAL"]) {
                        researchMap.set(item["RAZÓN SOCIAL"].trim(), item);
                    }
                });

                fullDatabaseData = []; // Limpiar datos anteriores
                const razonSocialKey = "RAZÓN SOCIAL";

                baseData.forEach(item => {
                    const razonSocial = item[razonSocialKey] ? item[razonSocialKey].trim() : null;

                    // Buscar en el mapa de investigación
                    if (razonSocial && researchMap.has(razonSocial)) {
                        const research = researchMap.get(razonSocial);
                        // Rellenar los campos WEB y CORREO ELECTRONICO
                        item.WEB = research.WEB;
                        item["CORREO ELECTRONICO"] = research["CORREO ELECTRONICO"];
                    }
                    
                    fullDatabaseData.push(item);
                });

                // Poblar la tabla
                populateTable();

                // Actualizar UI
                loadingSpinner.style.display = 'none';
                tableContainer.style.display = 'block';
                statusInfo.textContent = `Mostrando ${fullDatabaseData.length} empresas. ${researchMap.size} investigadas.`;
                downloadBtn.disabled = false;

            } catch (error) {
                handleError(error);
            }
        }
        
        function fetchAndParseCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    encoding: "UTF-8",
                    delimiter: ",", // Corregido a coma (,)
                    complete: resolve,
                    error: (err, file) => reject(new Error(`Error al parsear ${file}: ${err.message}`))
                });
            });
        }

        function handleError(err) {
            loadingSpinner.style.display = 'none';
            statusInfo.textContent = `Error: ${err.message}. Asegúrate de que los archivos estén en el repositorio y usen ',' como delimitador.`;
            statusInfo.classList.add('text-red-600');
        }
        
        function populateTable() {
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('data-table-body');
            
            tableBody.innerHTML = '';
            tableHeader.innerHTML = '';

            // 1. Crear Encabezado
            const headerRow = document.createElement('tr');
            const headerClasses = "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
            
            tableHeaders.forEach(header => {
                const th = document.createElement('th');
                th.scope = "col";
                th.className = headerClasses;
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHeader.appendChild(headerRow);

            // 2. Crear Filas de Datos
            fullDatabaseData.forEach(item => {
                const row = document.createElement('tr');
                tableHeaders.forEach(header => {
                    const cell = createTableCell(item, header);
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });
        }

        function createTableCell(item, header) {
            const cell = document.createElement('td');
            const cellValue = item[header] || '';
            const cellClasses = "px-6 py-4 whitespace-nowrap text-sm text-gray-700";
            const linkClasses = "text-blue-600 hover:text-blue-800 hover:underline";
            const notFoundClasses = "text-gray-400";

            cell.className = cellClasses;

            if (header === 'WEB' && cellValue && cellValue !== 'No encontrado') {
                cell.className = `${cellClasses} ${linkClasses}`;
                const link = document.createElement('a');
                const url = cellValue.startsWith('http') ? cellValue : `http://${cellValue}`;
                link.href = url;
                link.textContent = cellValue;
                link.target = "_blank";
                link.rel = "noopener noreferrer";
                cell.appendChild(link);
            } else if (header === 'CORREO ELECTRONICO' && cellValue && cellValue !== 'No encontrado') {
                cell.className = `${cellClasses} ${linkClasses}`;
                const mailLink = document.createElement('a');
                mailLink.href = `mailto:${cellValue}`;
                mailLink.textContent = cellValue;
                cell.appendChild(mailLink);
            } else if (header === 'RAZÓN SOCIAL') {
                cell.className = `${cellClasses} font-medium text-gray-900`;
                cell.textContent = cellValue;
            } else {
                 cell.textContent = cellValue;
                 if (cellValue === 'No encontrado' || !cellValue) {
                    cell.className = `${cellClasses} ${notFoundClasses}`;
                    if(!cellValue) cell.textContent = '---';
                 }
            }
            return cell;
        }

        function escapeCSV(field) {
            if (field === null || field === undefined) {
                return '';
            }
            let str = String(field);
            // Escapar para comas (,)
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                str = `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        }

        function downloadCSV() {
            if (fullDatabaseData.length === 0) return;
            
            let csvContent = tableHeaders.join(",") + "\n";
            
            fullDatabaseData.forEach(item => {
                const row = tableHeaders.map(header => escapeCSV(item[header]));
                csvContent += row.join(",") + "\n";
            });

            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // BOM para UTF-8 Excel
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "base_de_datos_actualizada.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
